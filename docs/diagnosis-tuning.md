# 診断チューニングまとめ

この文書は、現行の診断チューニング内容と、今後の調整方針を整理したものです。
設定の実体は `src/lib/diagnosis.ts` の `defaultDiagnosisTuning` にあります。

## 文系向け（ざっくり）
- 5段階の回答は「真ん中寄り」が多いと仮定しています。
- そのままだとスコアが中心に集まり、7番（バランス型）が出やすくなります。
- そこで次の3つで偏りを抑えています。
  - スコアを標準化して、平均的な偏りを打ち消す
  - 7番は「中心に近いときだけ」候補にする
  - 出すぎるタイプには軽いペナルティをかける
- さらに各タイプの座標を少し内側に寄せ、中心偏りを緩和しています。

## 現在の設定（要点）
- 設定場所: `src/lib/diagnosis.ts` の `defaultDiagnosisTuning`
- 想定回答分布: `+2:0.075, +1:0.25, 0:0.35, -1:0.25, -2:0.075`
- 軸の標準化: X/Yともに mean=0, std≈2.3452
- centroidScale: `0.6`
- deadZone: `enabled`, `threshold=0.6`, `centerTypeId=7`
- axisWeights: `x=1`, `y=1`
- typeBiases（距離に加算する補正値）

| id | モデル | bias |
| --- | --- | --- |
| 1 | 須貝駿貴 | -0.311635 |
| 2 | 鶴崎修功 | -0.21924 |
| 3 | 山本祥彰 | -0.0817525 |
| 4 | 東問 | -0.3836575 |
| 5 | ふくらP | 0.4910225 |
| 6 | 東言 | -0.545985 |
| 7 | 伊沢拓司 | 0.5497225 |
| 8 | 河村拓哉 | 0.501525 |

補足: biasは距離に加算されるため、正の値は「出にくく」、負の値は「出やすく」なります。

## 理系向け（詳しい説明）
### 1) スコアの標準化
想定分布の平均は0、分散は1.1です。
X/Y各軸は5問ずつなので、分散は `5 * 1.1 = 5.5`、標準偏差は `sqrt(5.5) ≈ 2.3452` になります。

標準化後のスコア:

```
x' = (x - meanX) / stdX
y' = (y - meanY) / stdY
```

（現状は対称分布なので meanX=meanY=0）

### 2) セントロイドの縮小
各タイプの座標は `centroidScale=0.6` を掛けて中心に寄せます。

```
cx' = (centroid.x * 0.6 - meanX) / stdX
cy' = (centroid.y * 0.6 - meanY) / stdY
```

### 3) 中心タイプのデッドゾーン
標準化後の座標が中央から外れている場合、7番を候補から除外します。

```
if |x'| > 0.6 or |y'| > 0.6:
  candidates = all types except id=7
```

### 4) 距離の計算（重み + バイアス）

```
distance = sqrt(((x' - cx') / wx)^2 + ((y' - cy') / wy)^2) + bias[id]
```

現状の `wx`/`wy` は 1.0 で、バイアスが均等化の主役です。

## 更なる調整について
### 1) 想定分布の見直し
ユーザーの回答傾向が変わったら、`scoreDistribution` を更新します。
例: 中立がもっと多い場合は `0` の比率を増やします。

### 2) 中心偏りの調整
- 7番が出すぎる → `deadZone.threshold` を下げる or `bias[7]` を上げる
- 7番が出にくすぎる → `deadZone.threshold` を上げる or `bias[7]` を下げる

### 3) 全体の出やすさ調整
- 外側タイプが出にくい → `centroidScale` を下げる
- 外側タイプが出やすい → `centroidScale` を上げる

### 4) 軸バランスの調整
- X軸の影響が強すぎる → `axisWeights.x` を大きくする
- Y軸の影響が強すぎる → `axisWeights.y` を大きくする

### 5) バイアスの再計算
頻度に応じて次のように更新すると、均等化に寄せられます。

```
bias[id] += k * (freq[id] - 0.125)
```

`k` は 0.3〜0.6 くらいから始めると調整しやすいです。

## 運用メモ
- デバッグUIは生のセントロイドを表示します（実判定は縮小後の座標）。
- 問題文や設問数が変わると標準化値も変わるため、再調整が必要です。
